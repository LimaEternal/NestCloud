{% extends "base.html" %}

{% block extra_css %}
{% endblock %}

{% block flash_messages %}
  {% if not current_user.is_authenticated %}
    {{ super() }}
  {% endif %}
{% endblock %}

{% block body %}
  {% if current_user.is_authenticated %}
    <div class="d-flex justify-content-between align-items-center mb-3 gap-3">
      <h1 class="mb-0">Ваши файлы <span class="text-muted">({{ files|length }})</span></h1>
      
      {% set messages = get_flashed_messages(with_categories=true) %}
      <div class="flex-grow-1 mx-3 alert-placeholder" id="uploadAlerts">
        {% if messages %}
          {% for category, message in messages %}
            {% if category == 'success' %}
              <div class="alert alert-success alert-timed mb-0" role="alert" data-duration="5000">
                <span>{{ message }}</span>
                <div class="alert-progress alert-progress-success"></div>
              </div>
            {% elif category == 'danger' %}
              <div class="alert alert-danger alert-timed mb-0" role="alert" data-duration="5000">
                <span>{{ message }}</span>
                <div class="alert-progress alert-progress-danger"></div>
              </div>
            {% else %}
              <div class="alert alert-secondary alert-timed mb-0" role="alert" data-duration="5000">
                <span>{{ message }}</span>
                <div class="alert-progress"></div>
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}
      </div>

      <!-- ФОРМА ЗАГРУЗКИ -->
      <form method="POST" enctype="multipart/form-data" action="{{ url_for('upload_file') }}" class="flex-shrink-0">
        {{ form.hidden_tag() }}
        <input type="file" name="file" id="fileInput" class="d-none">
        <div class="d-flex gap-2 align-items-stretch">
          <button type="button" class="btn btn-outline-primary text-start" id="selectFileBtn" style="min-width: 200px; min-height: 60px; display: flex; flex-direction: column; justify-content: center; align-items: flex-start;">
            <span id="fileLabelPrimary" class="fw-semibold d-block">Нажмите для выбора файла</span>
            <small id="fileLabelSecondary" class="text-muted d-block"></small>
          </button>
          <button class="btn btn-primary" type="submit" style="min-height: 60px;">Загрузить</button>
        </div>
      </form>
    </div>

    <!-- КНОПКА СОРТИРОВКИ -->
    <div class="d-flex justify-content-end mb-3">
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-secondary" id="sortBtn" 
                {% if not files %}disabled{% endif %}
                data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-sort-down"></i> Сортировать
        </button>
        <ul class="dropdown-menu dropdown-menu-end" id="sortDropdown">
          <li><a class="dropdown-item" href="#" data-sort="name-asc">
            <i class="bi bi-sort-alpha-down"></i> По имени (А-Я)
          </a></li>
          <li><a class="dropdown-item" href="#" data-sort="name-desc">
            <i class="bi bi-sort-alpha-up"></i> По имени (Я-А)
          </a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="#" data-sort="size-asc">
            <i class="bi bi-sort-numeric-down"></i> По размеру (возрастание)
          </a></li>
          <li><a class="dropdown-item" href="#" data-sort="size-desc">
            <i class="bi bi-sort-numeric-up"></i> По размеру (убывание)
          </a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="#" data-sort="time-asc">
            <i class="bi bi-sort-down"></i> По времени (старые сначала)
          </a></li>
          <li><a class="dropdown-item" href="#" data-sort="time-desc">
            <i class="bi bi-sort-up"></i> По времени (новые сначала)
          </a></li>
        </ul>
      </div>
    </div>

    <!-- СПИСОК ФАЙЛОВ -->
    {% if files %}
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th class="text-center">Имя файла</th>
              <th>Время загрузки</th>
              <th>Размер</th>
              <th class="text-center">Действия</th>
            </tr>
          </thead>
          <tbody id="filesTableBody">
            {% for file in files %}
              <tr data-filename="{{ file.filename }}" 
                  data-file-size="{{ file.file_size }}" 
                  data-upload-time="{{ file.upload_time.isoformat() }}">
                <td style="padding-left: 1rem;">
                  <div class="d-flex align-items-center file-row">
                    {% if file.preview_path %}
                      <img src="{{ url_for('preview_file', file_id=file.id) }}"
                           alt="Превью {{ file.filename }}"
                           class="file-thumb">
                    {% else %}
                      <div class="file-thumb placeholder border">
                        <i class="bi bi-file-earmark"></i>
                      </div>
                    {% endif %}
                    <div>
                      <p class="file-name fw-semibold mb-0">{{ file.filename }}</p>
                    </div>
                  </div>
                </td>
                <td>{{ file.upload_time.strftime("%d.%m.%Y %H:%M") }}</td>
                <td>{{ file.file_size }}</td>
                <td>
  <div class="d-flex justify-content-center gap-2">
    <a href="{{ url_for('download_file', file_id=file.id) }}" 
       class="btn btn-primary btn-sm">
      <i class="bi bi-download"></i> Скачать
    </a>
    <button type="button" class="btn btn-warning btn-sm" 
            data-bs-toggle="modal" 
            data-bs-target="#renameModal"
            data-file-id="{{ file.id }}"
            data-file-name="{{ file.filename }}">
      <i class="bi bi-pencil"></i> Переименовать
    </button>
    <form method="POST" action="{{ url_for('delete_file', file_id=file.id) }}" 
          onsubmit="return confirm('Вы уверены, что хотите удалить файл \'{{ file.filename }}\'? Это действие нельзя отменить.');" 
          style="display: inline;">
      <button type="submit" class="btn btn-danger btn-sm">
        <i class="bi bi-trash"></i> Удалить
      </button>
    </form>
  </div>
</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        У вас пока нет файлов. Используйте форму выше для загрузки.
      </div>
    {% endif %}

    <!-- МОДАЛЬНОЕ ОКНО ДЛЯ ПЕРЕИМЕНОВАНИЯ -->
    <div class="modal fade" id="renameModal" tabindex="-1" aria-labelledby="renameModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="renameModalLabel">Переименовать файл</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <form method="POST" id="renameForm" action="">
            <div class="modal-body">
              <div class="mb-0">
                <label for="newFilename" class="form-label">Новое имя файла</label>
                <input type="text" class="form-control" id="newFilename" required>
                <input type="hidden" id="newFilenameHidden" name="new_filename">
                <div class="form-text fs-6">
                  Текущее имя: <span id="currentFileName" class="fw-semibold"></span><br>
                  <small class="text-muted">Введите только имя файла без расширения. Расширение будет сохранено автоматически.</small>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
              <button type="submit" class="btn btn-primary">Сохранить</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="{{ url_for('static', filename='js/home.js') }}"></script>

  {% else %}
    <div class="text-center py-5">
      <i class="bi bi-cloud" style="font-size: 5rem; color: #0d6efd;"></i>
      <h1 class="mt-3">Добро пожаловать в NestCloud</h1>
      <p class="lead text-muted">Ваш надежный облачный сервис для хранения файлов</p>
      <div class="mt-4">
        <a href="{{ url_for('login_page') }}" class="btn btn-primary btn-lg mx-2">Войти</a>
        <a href="{{ url_for('register') }}" class="btn btn-outline-primary btn-lg mx-2">Регистрация</a>
      </div>
    </div>
  {% endif %}
{% endblock %}